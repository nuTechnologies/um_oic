<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/logo.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gruft Manager</title>
    <style>
      /* NU Xworks Design System - Proper Theme Layers */
      @layer theme {
        :root {
        --nu-color-icon-archive: rgb(251, 190, 84);
        --nu-color-icon-audio: rgb(112, 4, 96);
        --nu-color-icon-code: #171C1F;
        --nu-color-icon-document: rgb(59, 68, 166);
        --nu-color-icon-drawio: rgb(255, 111, 0);
        --nu-color-icon-epub: rgb(244, 187, 68);
        --nu-color-icon-file: #171C1F;
        --nu-color-icon-folder: rgb(77, 126, 175);
        --nu-color-icon-form: rgb(102, 166, 163);
        --nu-color-icon-graphic: rgb(235, 201, 74);
        --nu-color-icon-ifc: rgb(208, 67, 236);
        --nu-color-icon-image: rgb(238, 107, 59);
        --nu-color-icon-jupyter: rgb(243, 119, 38);
        --nu-color-icon-markdown: rgb(75, 100, 137);
        --nu-color-icon-medical: rgb(9, 132, 219);
        --nu-color-icon-pdf: rgb(236, 13, 71);
        --nu-color-icon-presentation: rgb(238, 107, 59);
        --nu-color-icon-root: rgb(0, 187, 219);
        --nu-color-icon-spreadsheet: rgb(21, 194, 134);
        --nu-color-icon-text: #171C1F;
        --nu-color-icon-video: rgb(4, 84, 89);
        --nu-font-family: xwork, Inter, sans-serif;
        --nu-role-background: #FBFCFE;
        --nu-role-chrome: #20434F;
        --nu-role-error: #BA1A1A;
        --nu-role-error-container: #FFDAD6;
        --nu-role-inverse-on-surface: #EFF1F2;
        --nu-role-inverse-primary: #5CD5FB;
        --nu-role-inverse-surface: #2E3132;
        --nu-role-on-background: #191C1D;
        --nu-role-on-chrome: #FFFFFF;
        --nu-role-on-error: #FFFFFF;
        --nu-role-on-error-container: #410002;
        --nu-role-on-primary: #FFFFFF;
        --nu-role-on-primary-container: #001F28;
        --nu-role-on-primary-fixed: #001F28;
        --nu-role-on-secondary: #FFFFFF;
        --nu-role-on-secondary-container: #071E26;
        --nu-role-on-secondary-fixed: #071E26;
        --nu-role-on-surface: #191C1D;
        --nu-role-on-surface-variant: #40484C;
        --nu-role-on-tertiary: #FFFFFF;
        --nu-role-on-tertiary-container: #171937;
        --nu-role-on-tertiary-fixed: #171937;
        --nu-role-outline: #70787C;
        --nu-role-outline-variant: #BFC8CC;
        --nu-role-primary: #00677F;
        --nu-role-primary-container: #B7EAFF;
        --nu-role-primary-fixed: #B7EAFF;
        --nu-role-scrim: #000000;
        --nu-role-secondary: #20434F;
        --nu-role-secondary-container: #CFE6F1;
        --nu-role-secondary-fixed: #CFE6F1;
        --nu-role-shadow: #000000;
        --nu-role-surface: #FBFCFE;
        --nu-role-surface-bright: #F8F9FB;
        --nu-role-surface-container: #ECEEF0;
        --nu-role-surface-container-high: #E7E8EA;
        --nu-role-surface-container-highest: #E1E3E4;
        --nu-role-surface-container-low: #F2F4F5;
        --nu-role-surface-container-lowest: #FFFFFF;
        --nu-role-surface-dim: #D8DADC;
        --nu-role-surface-tint: #715289;
        --nu-role-surface-variant: #DBE4E8;
        --nu-role-tertiary: #5A5C7E;
        --nu-role-tertiary-container: #E0E0FF;
        --nu-role-tertiary-fixed: #E0E0FF;

        /* nu Prefixed Variables (Original) */
        --nu-font-family: var(--nu-font-family);
        --nu-role-background: var(--nu-role-background);
        --nu-role-chrome: var(--nu-role-chrome);
        --nu-role-error: var(--nu-role-error);
        --nu-role-error-container: var(--nu-role-error-container);
        --nu-role-on-chrome: var(--nu-role-on-chrome);
        --nu-role-on-error: var(--nu-role-on-error);
        --nu-role-on-error-container: var(--nu-role-on-error-container);
        --nu-role-on-primary: var(--nu-role-on-primary);
        --nu-role-on-secondary: var(--nu-role-on-secondary);
        --nu-role-on-secondary-container: var(--nu-role-on-secondary-container);
        --nu-role-on-surface: var(--nu-role-on-surface);
        --nu-role-on-surface-variant: var(--nu-role-on-surface-variant);
        --nu-role-on-tertiary: var(--nu-role-on-tertiary);
        --nu-role-outline: var(--nu-role-outline);
        --nu-role-outline-variant: var(--nu-role-outline-variant);
        --nu-role-primary: var(--nu-role-primary);
        --nu-role-secondary: var(--nu-role-secondary);
        --nu-role-secondary-container: var(--nu-role-secondary-container);
        --nu-role-shadow: var(--nu-role-shadow);
        --nu-role-surface: var(--nu-role-surface);
        --nu-role-surface-container: var(--nu-role-surface-container);
        --nu-role-surface-container-high: var(--nu-role-surface-container-high);
        --nu-role-surface-container-highest: var(--nu-role-surface-container-highest);
        --nu-role-surface-container-low: var(--nu-role-surface-container-low);
        --nu-role-tertiary: var(--nu-role-tertiary);

        /* Theme-compatible Color Variables */
        --color-role-chrome: var(--nu-role-chrome);
        --color-role-error: var(--nu-role-error);
        --color-role-on-chrome: var(--nu-role-on-chrome);
        --color-role-on-error: var(--nu-role-on-error);
        --color-role-on-primary: var(--nu-role-on-primary);
        --color-role-on-secondary: var(--nu-role-on-secondary);
        --color-role-on-secondary-container: var(--nu-role-on-secondary-container);
        --color-role-on-surface: var(--nu-role-on-surface);
        --color-role-on-surface-variant: var(--nu-role-on-surface-variant);
        --color-role-on-tertiary: var(--nu-role-on-tertiary);
        --color-role-outline: var(--nu-role-outline);
        --color-role-outline-variant: var(--nu-role-outline-variant);
        --color-role-primary: var(--nu-role-primary);
        --color-role-secondary: var(--nu-role-secondary);
        --color-role-secondary-container: var(--nu-role-secondary-container);
        --color-role-shadow: var(--nu-role-shadow);
        --color-role-surface: var(--nu-role-surface);
        --color-role-surface-container: var(--nu-role-surface-container);
        --color-role-surface-container-high: var(--nu-role-surface-container-high);
        --color-role-surface-container-highest: var(--nu-role-surface-container-highest);
        --color-role-surface-container-low: var(--nu-role-surface-container-low);
        --color-role-tertiary: var(--nu-role-tertiary);

        /* Spacing System */
        --spacing: 4px;

        /* Container Sizes */
        --container-xs: 20rem;
        --container-sm: 24rem;
        --container-md: 28rem;
        --container-lg: 32rem;
        --container-xl: 36rem;
        --container-2xl: 42rem;

        /* Default Font */
        --default-font-family: var(--nu-font-family);
        }
      }

      /* NU Xworks Design System - Dark Mode Extension */
      :root[data-theme="dark"] {
        /* Icon Colors - bleiben meist gleich */
        --nu-color-icon-archive: rgb(251, 190, 84);
        --nu-color-icon-audio: rgb(112, 4, 96);
        --nu-color-icon-code: #FFFFFF;
        --nu-color-icon-document: rgb(100, 120, 200);
        --nu-color-icon-drawio: rgb(255, 111, 0);
        --nu-color-icon-epub: rgb(244, 187, 68);
        --nu-color-icon-file: #FFFFFF;
        --nu-color-icon-folder: rgb(120, 160, 210);
        --nu-color-icon-form: rgb(130, 190, 180);
        --nu-color-icon-graphic: rgb(255, 220, 100);
        --nu-color-icon-ifc: rgb(220, 100, 255);
        --nu-color-icon-image: rgb(255, 140, 90);
        --nu-color-icon-jupyter: rgb(255, 150, 70);
        --nu-color-icon-markdown: rgb(120, 140, 180);
        --nu-color-icon-medical: rgb(50, 160, 255);
        --nu-color-icon-pdf: rgb(255, 80, 120);
        --nu-color-icon-presentation: rgb(255, 140, 90);
        --nu-color-icon-root: rgb(50, 220, 255);
        --nu-color-icon-spreadsheet: rgb(60, 220, 160);
        --nu-color-icon-text: #FFFFFF;
        --nu-color-icon-video: rgb(50, 120, 140);

        /* Font Family bleibt gleich */
        --nu-font-family: xwork, Inter, sans-serif;

        /* Dark Mode Semantic Colors */
        --nu-role-background: #121212;
        --nu-role-chrome: #1F1F1F;
        --nu-role-error: #CF6679;
        --nu-role-error-container: #3A1A1B;
        --nu-role-inverse-on-surface: #121212;
        --nu-role-inverse-primary: #004D5C;
        --nu-role-inverse-surface: #E6E1E5;
        --nu-role-on-background: #E6E1E5;
        --nu-role-on-chrome: #E6E1E5;
        --nu-role-on-error: #000000;
        --nu-role-on-error-container: #FFDAD6;
        --nu-role-on-primary: #000000;
        --nu-role-on-primary-container: #B7EAFF;
        --nu-role-on-primary-fixed: #B7EAFF;
        --nu-role-on-secondary: #000000;
        --nu-role-on-secondary-container: #CFE6F1;
        --nu-role-on-secondary-fixed: #CFE6F1;
        --nu-role-on-surface: #E6E1E5;
        --nu-role-on-surface-variant: #CAC4D0;
        --nu-role-on-tertiary: #000000;
        --nu-role-on-tertiary-container: #E0E0FF;
        --nu-role-on-tertiary-fixed: #E0E0FF;
        --nu-role-outline: #938F99;
        --nu-role-outline-variant: #49454F;
        --nu-role-primary: #5CD5FB;
        --nu-role-primary-container: #004D5C;
        --nu-role-primary-fixed: #B7EAFF;
        --nu-role-scrim: #000000;
        --nu-role-secondary: #CFE6F1;
        --nu-role-secondary-container: #2A3F4A;
        --nu-role-secondary-fixed: #CFE6F1;
        --nu-role-shadow: #000000;
        --nu-role-surface: #1F1F1F;
        --nu-role-surface-bright: #383838;
        --nu-role-surface-container: #2B2B2B;
        --nu-role-surface-container-high: #323232;
        --nu-role-surface-container-highest: #3A3A3A;
        --nu-role-surface-container-low: #262626;
        --nu-role-surface-container-lowest: #1A1A1A;
        --nu-role-surface-dim: #141218;
        --nu-role-surface-tint: #A495C0;
        --nu-role-surface-variant: #49454F;
        --nu-role-tertiary: #E0E0FF;
        --nu-role-tertiary-container: #3D3F61;
        --nu-role-tertiary-fixed: #E0E0FF;

        /* Theme-compatible Color Variables */
        --color-role-chrome: var(--nu-role-chrome);
        --color-role-error: var(--nu-role-error);
        --color-role-on-chrome: var(--nu-role-on-chrome);
        --color-role-on-error: var(--nu-role-on-error);
        --color-role-on-primary: var(--nu-role-on-primary);
        --color-role-on-secondary: var(--nu-role-on-secondary);
        --color-role-on-secondary-container: var(--nu-role-on-secondary-container);
        --color-role-on-surface: var(--nu-role-on-surface);
        --color-role-on-surface-variant: var(--nu-role-on-surface-variant);
        --color-role-on-tertiary: var(--nu-role-on-tertiary);
        --color-role-outline: var(--nu-role-outline);
        --color-role-outline-variant: var(--nu-role-outline-variant);
        --color-role-primary: var(--nu-role-primary);
        --color-role-secondary: var(--nu-role-secondary);
        --color-role-secondary-container: var(--nu-role-secondary-container);
        --color-role-shadow: var(--nu-role-shadow);
        --color-role-surface: var(--nu-role-surface);
        --color-role-surface-container: var(--nu-role-surface-container);
        --color-role-surface-container-high: var(--nu-role-surface-container-high);
        --color-role-surface-container-highest: var(--nu-role-surface-container-highest);
        --color-role-surface-container-low: var(--nu-role-surface-container-low);
        --color-role-tertiary: var(--nu-role-tertiary);
      }

      /* Responsive Dark Mode Media Query */
      @media (prefers-color-scheme: dark) {
        :root:not([data-theme="light"]) {
          /* Auto-enable dark mode if system preference is dark */
          --nu-role-background: #121212;
          --nu-role-chrome: #1F1F1F;
          --nu-role-on-background: #E6E1E5;
          --nu-role-on-chrome: #E6E1E5;
          --nu-role-surface: #1F1F1F;
          --nu-role-on-surface: #E6E1E5;
          --nu-role-surface-container: #2B2B2B;
          --nu-role-outline: #938F99;
          --nu-role-outline-variant: #49454F;
        }
      }

      @layer base {
        *, :after, :before, ::backdrop {
          box-sizing: border-box;
          border: 0 solid;
          margin: 0;
          padding: 0;
          border-color: var(--oc-role-surface-container-highest, var(--nu-role-surface-container-highest));
        }

        body {
          font-family: var(--default-font-family);
          background: var(--oc-role-background, var(--nu-role-background));
          min-height: 100vh;
          color: var(--oc-role-on-background, var(--nu-role-on-background));
        }

        /* OpenCloud Design System Base */
        :root {
          --spacing: 4px;
          --radius-sm: 0.25rem;
          --text-base: 1rem;
          --text-base--line-height: 1.5;
          --tw-leading: 1.5;
        }
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      @layer components {
        h1 {
          color: var(--nu-role-on-background);
          text-align: center;
          margin-bottom: calc(var(--spacing) * 7.5);
          font-weight: 700;
          font-size: 2.5rem;
        }

      .loading {
        text-align: center;
        color: var(--nu-role-on-background);
        font-size: 1.2rem;
        margin: 50px 0;
      }

      .error {
        background: var(--nu-role-error-container);
        color: var(--nu-role-on-error-container);
        padding: 15px;
        border-radius: 4px;
        margin: 20px 0;
        border: 1px solid var(--nu-role-error);
      }

      .admin-panel {
        display: none;
      }

      /* Navigation */
      nav {
        padding: 15px;
        margin-bottom: 30px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        border-radius: 4px;
      }

      .nav-btn {
        padding: 10px 16px;
        border: 1px solid var(--color-role-primary);
        border-radius: 6px;
        background: transparent;
        color: var(--color-role-primary);
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        font-size: 0.9rem;
        font-family: var(--nu-font-family);
      }

      .nav-btn:hover {
        background: var(--nu-role-surface-container);
        color: var(--nu-role-on-surface);
      }

      .nav-btn.active {
        background: var(--nu-role-secondary);
        color: var(--nu-role-on-secondary);
        border: 1px solid var(--nu-role-secondary);
      }

      .logout-btn {
        margin-left: auto;
        background: var(--nu-role-error) !important;
        color: var(--nu-role-on-error) !important;
        border: 1px solid var(--nu-role-error) !important;
      }

      .logout-btn:hover {
        filter: brightness(85%) !important;
      }

      /* Theme Toggle Button */
      .theme-toggle {
        background: var(--nu-role-secondary) !important;
        color: var(--nu-role-on-secondary) !important;
        border: 1px solid var(--nu-role-outline) !important;
        transition: all 0.3s ease;
        font-size: 1rem;
        min-width: 40px;
        margin-left: 10px;
      }

      .theme-toggle:hover {
        filter: brightness(85%) !important;
        transform: scale(1.05);
      }

      /* Content Sections */
      .section {
        display: none;
        background: var(--nu-role-surface);
        border: 1px solid var(--color-role-primary);
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 1px 3px var(--nu-role-shadow);
      }

      .section.active {
        display: block;
      }

      .section h2 {
        color: var(--nu-role-on-surface);
        margin-bottom: 20px;
        font-size: 1.8rem;
        font-weight: 600;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
      }

      /* Buttons - NU Xworks Design System */
      .btn-primary {
        background: var(--nu-role-primary);
        color: var(--nu-role-on-primary);
        border: 1px solid var(--nu-role-primary);
        padding: 12px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-family: var(--nu-font-family);
      }

      .btn-primary:hover {
        filter: brightness(85%);
      }

      .btn-secondary, .btn-warning {
        padding: 10px 16px;
        border: 1px solid var(--nu-role-outline);
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        font-family: var(--nu-font-family);
      }

      .btn-secondary {
        background: var(--nu-role-secondary);
        color: var(--nu-role-on-secondary);
        border-color: var(--nu-role-secondary);
      }

      .btn-secondary:hover {
        filter: brightness(85%);
      }

      .btn-warning {
        background: var(--nu-role-error);
        color: var(--nu-role-on-error);
        border-color: var(--nu-role-error);
      }

      .btn-warning:hover {
        filter: brightness(85%);
      }

      /* Modern Dashboard Stats - NU Xworks Style */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 24px;
        margin: 32px 0;
      }

      .stat-card {
        background: var(--nu-role-surface);
        border-radius: 16px;
        padding: 32px 28px;
        text-align: left;
        border: 1px solid var(--nu-role-outline-variant);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 4px 16px rgba(0, 0, 0, 0.06);
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--nu-role-primary), var(--nu-role-secondary));
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 8px 32px rgba(0, 0, 0, 0.12);
        border-color: var(--nu-role-outline);
      }

      .stat-card:hover::before {
        opacity: 1;
      }

      .stat-card .stat-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
      }

      .stat-card .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: var(--nu-role-primary-container);
        color: var(--nu-role-on-primary-container);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .stat-card h3 {
        font-size: 2.8rem;
        margin: 0 0 8px 0;
        color: var(--nu-role-on-surface);
        font-weight: 700;
        line-height: 1;
      }

      .stat-card p {
        margin: 0;
        color: var(--nu-role-on-surface-variant);
        font-weight: 500;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-card .stat-trend {
        margin-top: 16px;
        font-size: 0.8rem;
        color: var(--nu-role-on-surface-variant);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* Modern Tables - NU Xworks Style */
      .table-container {
        background: var(--nu-role-surface);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1), 0 4px 16px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--nu-role-outline-variant);
        overflow: hidden;
        margin: 20px 0;
      }

      .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.9rem;
      }

      .data-table th {
        background: var(--nu-role-surface-container-high);
        padding: 16px 20px;
        text-align: left;
        font-weight: 600;
        color: var(--nu-role-on-surface-variant);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--nu-role-outline-variant);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .data-table th:first-child {
        padding-left: 24px;
      }

      .data-table th:last-child {
        padding-right: 24px;
        text-align: right;
      }

      .data-table td {
        padding: 16px 20px;
        border-bottom: 1px solid var(--nu-role-outline-variant);
        color: var(--nu-role-on-surface);
        line-height: 1.4;
        vertical-align: middle;
      }

      .data-table td:first-child {
        padding-left: 24px;
        font-weight: 500;
      }

      .data-table td:last-child {
        padding-right: 24px;
        text-align: right;
      }

      .data-table tbody tr {
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .data-table tbody tr:hover {
        background: var(--nu-role-surface-container);
        box-shadow: inset 0 1px 0 var(--nu-role-outline-variant);
      }

      .data-table tbody tr:last-child td {
        border-bottom: none;
      }

      .table-loading {
        text-align: center;
        color: var(--nu-role-on-surface-variant);
        font-style: italic;
        padding: 60px 40px;
        font-size: 0.9rem;
      }

      /* Status Cards */
      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .status-card {
        background: var(--nu-role-surface-container);
        border-radius: 12px;
        padding: 25px;
        border: 1px solid var(--nu-role-outline);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px var(--nu-role-shadow);
      }

      .status-card h3 {
        color: var(--nu-role-on-surface);
        margin-bottom: 15px;
        font-size: 1.2rem;
      }

      .status-indicator {
        font-size: 1.1rem;
        margin-top: 10px;
        font-weight: 500;
        color: var(--nu-role-on-surface);
      }

      .system-actions {
        margin-top: 30px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      /* Filters */
      .audit-filters {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        align-items: center;
        flex-wrap: wrap;
      }

      .audit-filters input {
        padding: 10px 12px;
        border: 2px solid var(--nu-role-outline);
        border-radius: 8px;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
        background: var(--nu-role-surface);
        color: var(--nu-role-on-surface);
        font-family: var(--nu-font-family);
      }

      .audit-filters input:focus {
        outline: none;
        border-color: var(--nu-role-primary);
        background: var(--nu-role-surface-bright);
      }

      /* User Controls */
      .users-controls {
        display: flex;
        gap: 20px;
        margin-bottom: 25px;
        align-items: center;
        flex-wrap: wrap;
      }

      .search-container {
        flex: 1;
        min-width: 300px;
      }

      .search-container input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--nu-role-outline);
        border-radius: 8px;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
        background: var(--nu-role-surface);
        color: var(--nu-role-on-surface);
        font-family: var(--nu-font-family);
      }

      .search-container input:focus {
        outline: none;
        border-color: var(--nu-role-primary);
        background: var(--nu-role-surface-bright);
      }

      .filter-container {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .filter-container select {
        padding: 10px 14px;
        border: 2px solid var(--nu-role-outline);
        border-radius: 8px;
        font-size: 0.9rem;
        background: var(--nu-role-surface);
        color: var(--nu-role-on-surface);
        font-family: var(--nu-font-family);
        cursor: pointer;
        min-width: 150px;
      }

        .filter-container select:focus {
          outline: none;
          border-color: var(--nu-role-primary);
        }
      }

      /* Status Badges */
      .status-active {
        background: var(--nu-role-secondary-container);
        color: var(--nu-role-on-secondary-container);
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .status-inactive {
        background: var(--nu-role-error-container);
        color: var(--nu-role-on-error-container);
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      /* Modern Action Buttons - NU Xworks Style */
      .actions-container {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: flex-end;
      }

      /* Pagination Styles */
      .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 24px;
        padding: 16px 0;
        border-top: 1px solid var(--nu-role-outline-variant);
      }

      .pagination-info {
        color: var(--nu-role-on-surface-variant);
        font-size: 0.875rem;
      }

      .pagination-controls {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .pagination-controls button {
        padding: 8px 16px;
        font-size: 0.875rem;
      }

      .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      #users-page-info {
        color: var(--nu-role-on-surface);
        font-weight: 500;
        min-width: 100px;
        text-align: center;
      }

      /* Checkbox Styles */
      .checkbox-group {
        margin: 12px 0;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        font-size: 0.875rem;
        color: var(--nu-role-on-surface);
      }

      .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--nu-role-primary);
        cursor: pointer;
      }

      .checkbox-text {
        user-select: none;
      }

      /* Status Toggle Button */
      .status-toggle {
        background: none;
        border: 1px solid;
        border-radius: 16px;
        padding: 4px 12px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 70px;
      }

      .status-toggle.status-active {
        background: var(--nu-role-primary);
        color: var(--nu-role-on-primary);
        border-color: var(--nu-role-primary);
      }

      .status-toggle.status-active:hover {
        background: var(--nu-role-primary-container);
        color: var(--nu-role-on-primary-container);
        border-color: var(--nu-role-primary-container);
      }

      .status-toggle.status-inactive {
        background: var(--nu-role-error-container);
        color: var(--nu-role-on-error-container);
        border-color: var(--nu-role-error);
      }

      .status-toggle.status-inactive:hover {
        background: var(--nu-role-error);
        color: var(--nu-role-on-error);
        border-color: var(--nu-role-error);
      }

      .action-btn {
        background: transparent;
        color: var(--nu-role-on-surface-variant);
        border: 1px solid var(--nu-role-outline-variant);
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.2s ease;
        font-weight: 500;
        font-family: var(--nu-font-family);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        min-width: 32px;
        height: 32px;
        justify-content: center;
      }

      .action-btn:hover {
        background: var(--nu-role-surface-container);
        color: var(--nu-role-on-surface);
        border-color: var(--nu-role-outline);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .action-btn.primary {
        background: var(--nu-role-primary);
        color: var(--nu-role-on-primary);
        border-color: var(--nu-role-primary);
      }

      .action-btn.primary:hover {
        background: var(--nu-role-primary);
        filter: brightness(85%);
      }

      .action-btn.danger {
        color: var(--nu-role-error);
        border-color: var(--nu-role-error);
      }

      .action-btn.danger:hover {
        background: var(--nu-role-error-container);
        color: var(--nu-role-on-error-container);
        border-color: var(--nu-role-error);
      }

      .action-btn.secondary {
        background: var(--nu-role-secondary-container);
        color: var(--nu-role-on-secondary-container);
        border-color: var(--nu-role-secondary);
      }

      .action-btn.secondary:hover {
        background: var(--nu-role-secondary);
        color: var(--nu-role-on-secondary);
      }

      /* Icon styles for buttons */
      .action-btn .icon {
        font-size: 0.9rem;
        line-height: 1;
      }

      /* Modal Styles - NU Xworks Design */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: var(--nu-role-surface);
        border: 1px solid var(--nu-role-outline-variant);
        border-radius: 12px;
        padding: 24px;
        max-width: 520px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .modal-header {
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--nu-role-outline-variant);
      }

      .modal-header h3 {
        margin: 0;
        color: var(--nu-role-on-surface);
        font-size: 1.5rem;
        font-weight: 600;
      }

      .modal-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* Compact Form Layout */
      .compact-form {
        gap: 16px;
      }

      .form-row {
        display: flex;
        gap: 16px;
        align-items: flex-start;
      }

      .form-group.half-width {
        flex: 1;
        min-width: 0;
      }

      .compact-form .form-group {
        margin-bottom: 0;
      }

      .compact-form label {
        font-size: 0.875rem;
        margin-bottom: 4px;
        font-weight: 500;
      }

      .compact-form .form-input {
        padding: 8px 12px;
        font-size: 0.875rem;
        height: auto;
        min-height: 36px;
      }

      .compact-form .form-error {
        font-size: 0.75rem;
        margin-top: 2px;
        min-height: 16px;
      }

      /* Compact Modal Actions */
      .compact-form + .modal-actions {
        margin-top: 20px;
        padding-top: 16px;
      }

      .compact-form .btn-modal {
        padding: 8px 16px;
        font-size: 0.875rem;
      }

      /* Large Modal for Claims Editor */
      .large-modal {
        max-width: 800px;
        width: 95%;
      }

      .user-claims-content {
        margin: 0 -4px;
      }

      .claims-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 16px 20px;
        background: var(--nu-role-surface-variant);
        border-radius: 8px;
        border: 1px solid var(--nu-role-outline-variant);
      }

      .claims-info {
        color: var(--nu-role-on-surface-variant);
        font-size: 0.875rem;
        font-weight: 500;
      }

      .claims-toolbar .btn-primary {
        padding: 8px 16px;
        font-size: 0.875rem;
      }

      /* Compact Claims Table */
      .data-table th:nth-child(4),
      .data-table th:nth-child(5),
      .data-table th:nth-child(6),
      .data-table th:nth-child(7) {
        width: 60px;
        text-align: center;
      }

      .data-table td:nth-child(4),
      .data-table td:nth-child(5),
      .data-table td:nth-child(6),
      .data-table td:nth-child(7) {
        text-align: center;
        width: 60px;
      }

      /* Checkbox Options Container */
      .checkbox-options-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        border: 1px solid var(--nu-role-outline-variant);
        border-radius: 8px;
        background: var(--nu-role-surface-variant);
        max-height: 200px;
        overflow-y: auto;
      }

      .option-checkbox {
        margin: 0;
        padding: 4px 0;
      }

      .option-checkbox .checkbox-text {
        font-size: 0.875rem;
        font-weight: normal;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-group label {
        color: var(--nu-role-on-surface);
        font-weight: 500;
        font-size: 0.9rem;
      }

      .form-input {
        padding: 12px 16px;
        border: 2px solid var(--nu-role-outline);
        border-radius: 8px;
        background: var(--nu-role-surface);
        color: var(--nu-role-on-surface);
        font-family: var(--nu-font-family);
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--nu-role-primary);
        background: var(--nu-role-surface-bright);
      }

      .form-input.error {
        border-color: var(--nu-role-error);
      }

      .form-error {
        color: var(--nu-role-error);
        font-size: 0.8rem;
        margin-top: 4px;
      }

      .form-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .form-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--nu-role-primary);
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 32px;
        padding-top: 16px;
        border-top: 1px solid var(--nu-role-outline-variant);
      }

      .btn-modal {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid;
        font-family: var(--nu-font-family);
      }

      .btn-modal-primary {
        background: var(--nu-role-primary);
        color: var(--nu-role-on-primary);
        border-color: var(--nu-role-primary);
      }

      .btn-modal-primary:hover {
        filter: brightness(85%);
      }

      .btn-modal-secondary {
        background: transparent;
        color: var(--nu-role-on-surface);
        border-color: var(--nu-role-outline);
      }

      .btn-modal-secondary:hover {
        background: var(--nu-role-surface-container);
      }

      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        h1 {
          font-size: 2rem;
        }

        nav {
          padding: 10px;
        }

        .nav-btn {
          padding: 8px 12px;
          font-size: 0.8rem;
        }

        .section {
          padding: 20px;
        }

        .section-header {
          flex-direction: column;
          align-items: stretch;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .system-actions {
          flex-direction: column;
        }

        .audit-filters {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Gruft Manager</h1>

      <div id="loading" class="loading">
        Authentifizierung wird überprüft...
      </div>

      <div id="error" class="error" style="display: none;"></div>

      <div id="admin-panel" class="admin-panel">
        <!-- Navigation -->
        <nav>
          <button onclick="showSection('dashboard')" class="nav-btn active" id="nav-dashboard">Dashboard</button>
          <button onclick="showSection('users')" class="nav-btn" id="nav-users">Benutzer</button>
          <button onclick="showSection('orgs')" class="nav-btn" id="nav-orgs">Organisationen</button>
          <button onclick="showSection('clients')" class="nav-btn" id="nav-clients">Clients</button>
          <button onclick="showSection('claims')" class="nav-btn" id="nav-claims">Claims</button>
          <button onclick="showSection('system')" class="nav-btn" id="nav-system">System</button>
          <button onclick="showSection('audit')" class="nav-btn" id="nav-audit">Audit</button>
          <button onclick="toggleTheme()" class="nav-btn theme-toggle" id="theme-toggle">Theme</button>
          <button onclick="logout()" class="nav-btn logout-btn">Abmelden</button>
        </nav>

        <!-- Dashboard Section -->
        <div id="section-dashboard" class="section active">
          <h2>Gruft Manager Dashboard</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <h3 id="stats-users">-</h3>
              <p>Benutzer</p>
              <div class="stat-trend">
                <span>Aktive Benutzer</span>
              </div>
            </div>
            <div class="stat-card">
              <h3 id="stats-orgs">-</h3>
              <p>Organisationen</p>
              <div class="stat-trend">
                <span>Verwaltete Einheiten</span>
              </div>
            </div>
            <div class="stat-card">
              <h3 id="stats-clients">-</h3>
              <p>OAuth2 Clients</p>
              <div class="stat-trend">
                <span>Anwendungen</span>
              </div>
            </div>
            <div class="stat-card">
              <h3 id="stats-claims">-</h3>
              <p>Claims</p>
              <div class="stat-trend">
                <span>Claim Definitionen</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Users Section -->
        <div id="section-users" class="section">
          <div class="section-header">
            <h2>Benutzerverwaltung</h2>
            <button onclick="showCreateUserModal()" class="btn-primary">Neuer Benutzer</button>
          </div>

          <!-- Search and filter controls -->
          <div class="users-controls">
            <div class="search-container">
              <input type="text" id="users-search" placeholder="Suche nach E-Mail, Name oder Organisation..." onkeyup="searchUsers()">
            </div>
            <div class="filter-container">
              <select id="users-org-filter" onchange="filterUsers()">
                <option value="">Alle Organisationen</option>
              </select>
              <select id="users-status-filter" onchange="filterUsers()">
                <option value="">Alle Status</option>
                <option value="active">Aktiv</option>
                <option value="inactive">Inaktiv</option>
                <option value="pending">Ausstehend</option>
              </select>
            </div>
          </div>

          <div class="table-container">
            <table id="users-table" class="data-table">
              <thead>
                <tr>
                  <th>E-Mail</th>
                  <th>Name</th>
                  <th>Organisation</th>
                  <th>Status</th>
                  <th>Rollen</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="users-tbody">
                <tr><td colspan="6" class="table-loading">Laden...</td></tr>
              </tbody>
            </table>
          </div>

          <div class="pagination-container">
            <div class="pagination-info">
              <span id="users-info">Zeige 0 von 0 Benutzern</span>
            </div>
            <div class="pagination-controls">
              <button id="users-prev" class="btn-secondary" onclick="changeUsersPage(-1)" disabled>Vorherige</button>
              <span id="users-page-info">Seite 1 von 1</span>
              <button id="users-next" class="btn-secondary" onclick="changeUsersPage(1)" disabled>Nächste</button>
            </div>
          </div>
        </div>

        <!-- Organizations Section -->
        <div id="section-orgs" class="section">
          <div class="section-header">
            <h2>Organisationen</h2>
            <button onclick="showCreateOrgModal()" class="btn-primary">Neue Organisation</button>
          </div>
          <div class="table-container">
            <table id="orgs-table" class="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Beschreibung</th>
                  <th>Mitglieder</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="orgs-tbody">
                <tr><td colspan="4" class="loading">Laden...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Clients Section -->
        <div id="section-clients" class="section">
          <div class="section-header">
            <h2>OAuth2-Client Management</h2>
            <button onclick="showCreateClientModal()" class="btn-primary">Neuer Client</button>
          </div>
          <div class="table-container">
            <table id="clients-table" class="data-table">
              <thead>
                <tr>
                  <th>Client ID</th>
                  <th>Name</th>
                  <th>Typ</th>
                  <th>Redirect URIs</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="clients-tbody">
                <tr><td colspan="5" class="loading">Laden...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Claims Section -->
        <div id="section-claims" class="section">
          <div class="section-header">
            <h2>Claim Definitionen</h2>
            <button onclick="showCreateClaimModal()" class="btn-primary">Neuer Claim</button>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Claim Key</th>
                  <th>Typ</th>
                  <th>Beschreibung</th>
                  <th>Erf.</th>
                  <th>Std.</th>
                  <th>Admin</th>
                  <th>Sens.</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="claims-tbody">
                <tr><td colspan="8" class="table-loading">Laden...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- System Section -->
        <div id="section-system" class="section">
          <h2>System-Status</h2>
          <div class="status-grid">
            <div class="status-card">
              <h3>Auth Service</h3>
              <div id="auth-status" class="status-indicator">Prüfen...</div>
            </div>
            <div class="status-card">
              <h3>Admin Service</h3>
              <div id="admin-status" class="status-indicator">Online</div>
            </div>
            <div class="status-card">
              <h3>Daten-Synchronisation</h3>
              <div id="data-status" class="status-indicator">Prüfen...</div>
            </div>
          </div>
          <div class="system-actions">
            <button onclick="reloadAuthData()" class="btn-warning">Auth-Daten neu laden</button>
            <button onclick="refreshSystemStatus()" class="btn-secondary">Status aktualisieren</button>
          </div>
        </div>

        <!-- Audit Section -->
        <div id="section-audit" class="section">
          <h2>Audit-Logs</h2>
          <div class="audit-filters">
            <input type="text" id="audit-user-filter" placeholder="Benutzer-ID">
            <input type="text" id="audit-event-filter" placeholder="Event-Typ">
            <button onclick="loadAuditLogs()" class="btn-secondary">Filtern</button>
          </div>
          <div class="table-container">
            <table id="audit-table" class="data-table">
              <thead>
                <tr>
                  <th>Zeitstempel</th>
                  <th>Event</th>
                  <th>Benutzer</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="audit-tbody">
                <tr><td colspan="4" class="loading">Laden...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="cache-info">
          Cache-Buster: <span id="cache-version">v1.0</span>
        </div>
      </div>

      <!-- User Edit Modal -->
      <div id="user-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="user-modal-title">Benutzer bearbeiten</h3>
          </div>
          <form id="user-form" class="modal-form compact-form">
            <div class="form-row">
              <div class="form-group half-width">
                <label for="user-id">Benutzer-ID *</label>
                <input type="text" id="user-id" class="form-input" required placeholder="eindeutige Benutzer-ID">
                <div class="form-error" id="user-id-error"></div>
              </div>
              <div class="form-group half-width">
                <label for="user-email">E-Mail *</label>
                <input type="email" id="user-email" class="form-input" required>
                <div class="form-error" id="user-email-error"></div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group half-width">
                <label for="user-first-name">Vorname *</label>
                <input type="text" id="user-first-name" class="form-input" required>
                <div class="form-error" id="user-first-name-error"></div>
              </div>
              <div class="form-group half-width">
                <label for="user-last-name">Nachname *</label>
                <input type="text" id="user-last-name" class="form-input" required>
                <div class="form-error" id="user-last-name-error"></div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group half-width">
                <label for="user-org">Organisation *</label>
                <select id="user-org" class="form-input" required>
                  <option value="">Organisation wählen...</option>
                </select>
                <div class="form-error" id="user-org-error"></div>
              </div>
              <div class="form-group half-width">
                <label for="user-password">Passwort</label>
                <input type="password" id="user-password" class="form-input">
                <div class="form-error" id="user-password-error"></div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <div class="form-checkbox">
                  <input type="checkbox" id="user-active">
                  <label for="user-active">Aktiv</label>
                </div>
              </div>
            </div>
          </form>
          <div class="modal-actions">
            <button type="button" class="btn-modal btn-modal-secondary" onclick="closeModal('user-modal')">Abbrechen</button>
            <button type="button" class="btn-modal btn-modal-primary" onclick="saveUser()">Speichern</button>
          </div>
        </div>
      </div>

      <!-- Organization Edit Modal -->
      <div id="org-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="org-modal-title">Organisation bearbeiten</h3>
          </div>
          <form id="org-form" class="modal-form">
            <div class="form-group">
              <label for="org-id">ID *</label>
              <input type="text" id="org-id" class="form-input" required>
              <div class="form-error" id="org-id-error"></div>
            </div>
            <div class="form-group">
              <label for="org-name">Name *</label>
              <input type="text" id="org-name" class="form-input" required>
              <div class="form-error" id="org-name-error"></div>
            </div>
            <div class="form-group">
              <label for="org-description">Beschreibung</label>
              <textarea id="org-description" class="form-input" rows="3"></textarea>
              <div class="form-error" id="org-description-error"></div>
            </div>
          </form>
          <div class="modal-actions">
            <button type="button" class="btn-modal btn-modal-secondary" onclick="closeModal('org-modal')">Abbrechen</button>
            <button type="button" class="btn-modal btn-modal-primary" onclick="saveOrg()">Speichern</button>
          </div>
        </div>
      </div>

      <!-- Client Edit Modal -->
      <div id="client-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="client-modal-title">Client bearbeiten</h3>
          </div>
          <form id="client-form" class="modal-form">
            <div class="form-group">
              <label for="client-id">Client ID *</label>
              <input type="text" id="client-id" class="form-input" required>
              <div class="form-error" id="client-id-error"></div>
            </div>
            <div class="form-group">
              <label for="client-name">Name *</label>
              <input type="text" id="client-name" class="form-input" required>
              <div class="form-error" id="client-name-error"></div>
            </div>
            <div class="form-group">
              <label for="client-type">Client Typ</label>
              <select id="client-type" class="form-input">
                <option value="confidential">Confidential</option>
                <option value="public">Public</option>
              </select>
            </div>
            <div class="form-group">
              <label for="client-redirect-uris">Redirect URIs (eine pro Zeile)</label>
              <textarea id="client-redirect-uris" class="form-input" rows="4"></textarea>
              <div class="form-error" id="client-redirect-uris-error"></div>
            </div>
            <div class="form-group">
              <label for="client-scopes">Erlaubte Scopes (durch Leerzeichen getrennt)</label>
              <input type="text" id="client-scopes" class="form-input" placeholder="openid profile email">
              <div class="form-error" id="client-scopes-error"></div>
            </div>
            <div class="form-group">
              <div class="form-checkbox">
                <input type="checkbox" id="client-require-pkce">
                <label for="client-require-pkce">PKCE erforderlich</label>
              </div>
            </div>
          </form>
          <div class="modal-actions">
            <button type="button" class="btn-modal btn-modal-secondary" onclick="closeModal('client-modal')">Abbrechen</button>
            <button type="button" class="btn-modal btn-modal-primary" onclick="saveClient()">Speichern</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Claims Modal -->
    <div id="claim-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="claim-modal-title">Claim bearbeiten</h3>
        </div>
        <form id="claim-form" class="modal-form compact-form">
          <div class="form-row">
            <div class="form-group half-width">
              <label for="claim-key">Claim Key *</label>
              <input type="text" id="claim-key" class="form-input" required>
              <div class="form-error" id="claim-key-error"></div>
            </div>
            <div class="form-group half-width">
              <label for="claim-type">Typ *</label>
              <select id="claim-type" class="form-input" required onchange="updateClaimDefaultInput()">
                <option value="">Wählen Sie einen Typ</option>
                <option value="string">String</option>
                <option value="number">Number</option>
                <option value="boolean">Boolean</option>
                <option value="array">Array</option>
                <option value="object">Object</option>
              </select>
              <div class="form-error" id="claim-type-error"></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="claim-description">Beschreibung</label>
              <textarea id="claim-description" class="form-input" rows="2" placeholder="Beschreibung des Claims"></textarea>
              <div class="form-error" id="claim-description-error"></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group half-width">
              <label for="claim-default-value">Default-Wert</label>
              <div id="claim-default-container">
                <input type="text" id="claim-default-value" class="form-input" placeholder="Standard-Wert">
              </div>
              <div class="form-error" id="claim-default-value-error"></div>
            </div>
            <div class="form-group half-width">
              <label for="claim-options">Vordefinierte Optionen</label>
              <textarea id="claim-options" class="form-input" rows="2" placeholder="Für Arrays: Eine Option pro Zeile&#10;z.B.: admin&#10;user&#10;moderator"></textarea>
              <div class="form-error" id="claim-options-error"></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group half-width">
              <div class="form-group checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="claim-required">
                  <span class="checkbox-text">Erforderlich</span>
                </label>
              </div>
              <div class="form-group checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="claim-standard-allowed">
                  <span class="checkbox-text">Standard erlaubt</span>
                </label>
              </div>
            </div>
            <div class="form-group half-width">
              <div class="form-group checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="claim-admin-only">
                  <span class="checkbox-text">Admin Only</span>
                </label>
              </div>
              <div class="form-group checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="claim-sensitive">
                  <span class="checkbox-text">Sensitiv</span>
                </label>
              </div>
            </div>
          </div>
        </form>
        <div class="modal-actions">
          <button type="button" class="btn-modal btn-modal-secondary" onclick="closeModal('claim-modal')">Abbrechen</button>
          <button type="button" class="btn-modal btn-modal-primary" onclick="saveClaim()">Speichern</button>
        </div>
      </div>
    </div>

    <!-- User Claims Modal -->
    <div id="user-claims-modal" class="modal">
      <div class="modal-content large-modal">
        <div class="modal-header">
          <h3 id="user-claims-modal-title">Claims für Benutzer</h3>
        </div>
        <div class="user-claims-content">
          <div class="claims-toolbar">
            <button onclick="addUserClaim()" class="btn-primary">Neuer Claim</button>
            <div class="claims-info">
              <span id="user-claims-count">0 Claims</span>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Claim Key</th>
                  <th>Typ</th>
                  <th>Wert</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="user-claims-tbody">
                <tr><td colspan="4" class="table-loading">Laden...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-modal btn-modal-secondary" onclick="closeModal('user-claims-modal')">Schließen</button>
          <button type="button" class="btn-modal btn-modal-primary" onclick="saveUserClaims()">Speichern</button>
        </div>
      </div>
    </div>

    <!-- User Claim Edit Modal -->
    <div id="user-claim-edit-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="user-claim-edit-title">Claim bearbeiten</h3>
        </div>
        <form id="user-claim-form" class="modal-form">
          <div class="form-group">
            <label for="user-claim-key">Claim Key *</label>
            <select id="user-claim-key" class="form-input" required onchange="updateClaimValueInput()">
              <option value="">Claim wählen...</option>
            </select>
            <div class="form-error" id="user-claim-key-error"></div>
          </div>
          <div class="form-group">
            <label for="user-claim-value">Wert *</label>
            <div id="user-claim-value-container">
              <input type="text" id="user-claim-value" class="form-input" required>
            </div>
            <div class="form-error" id="user-claim-value-error"></div>
          </div>
        </form>
        <div class="modal-actions">
          <button type="button" class="btn-modal btn-modal-secondary" onclick="closeModal('user-claim-edit-modal')">Abbrechen</button>
          <button type="button" class="btn-modal btn-modal-primary" onclick="saveUserClaim()">Speichern</button>
        </div>
      </div>
    </div>

    <script>
      // Check authentication on page load
      document.addEventListener('DOMContentLoaded', function() {
        checkAuthentication();
        initializeTheme();
      });

      function checkAuthentication() {
        console.log('🔍 Checking authentication...');

        try {
          // Check for token in URL parameters (from auth service redirect)
          const urlParams = new URLSearchParams(window.location.search);
          const tokenFromUrl = urlParams.get('token');

          if (tokenFromUrl) {
            console.log('🔗 Token found in URL, storing...');
            localStorage.setItem('auth_token', tokenFromUrl);
            // Clean URL
            window.history.replaceState({}, document.title, window.location.pathname);
          }

          // Check for stored token
          const token = localStorage.getItem('auth_token');

          if (!token) {
            console.log('❌ No token found, redirecting to auth service...');
            redirectToAuth();
            return;
          }

          console.log('🔑 Token found, validating...', token.substring(0, 20) + '...');

          // Add fallback in case validation hangs
          const fallbackTimeout = setTimeout(() => {
            console.warn('⚠️ Token validation taking too long, forcing redirect...');
            showError('Authentifizierung dauert zu lange. Sie werden zum Login weitergeleitet...');
            localStorage.removeItem('auth_token');
            redirectToAuth();
          }, 15000); // 15 second fallback

          validateToken(token).finally(() => {
            clearTimeout(fallbackTimeout);
          });

        } catch (error) {
          console.error('💥 Error in checkAuthentication:', error);
          showError('Fehler bei der Authentifizierungsprüfung: ' + error.message);
          setTimeout(() => redirectToAuth(), 2000);
        }
      }

      function redirectToAuth() {
        const currentUrl = encodeURIComponent(window.location.href);
        const authUrl = `https://localhost:8443/?redirect=${currentUrl}`;
        console.log('Redirecting to:', authUrl);
        window.location.href = authUrl;
      }

      async function validateToken(token) {
        console.log('Starting token validation...');

        try {
          const timestamp = Date.now();
          const controller = new AbortController();

          // Set timeout for request
          const timeoutId = setTimeout(() => {
            console.warn('Token validation timed out, aborting...');
            controller.abort();
          }, 10000); // 10 second timeout

          const response = await fetch(`/api/system/status?_cb=${timestamp}`, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Cache-Control': 'no-cache, no-store, must-revalidate',
              'Pragma': 'no-cache',
              'Expires': '0'
            },
            signal: controller.signal
          });

          clearTimeout(timeoutId);

          if (response.ok) {
            console.log('✅ Token valid, showing admin panel');
            showAdminPanel();
          } else {
            const errorText = await response.text().catch(() => 'Unknown error');
            console.warn('❌ Token invalid:', response.status, response.statusText, errorText);
            showError(`Token ungültig (${response.status}): ${response.statusText}. Sie werden zum Login weitergeleitet...`);
            localStorage.removeItem('auth_token');
            setTimeout(() => redirectToAuth(), 2000);
          }
        } catch (error) {
          console.error('🔥 Token validation error:', error);

          if (error.name === 'AbortError') {
            console.warn('Token validation was aborted due to timeout');
            showError('Token-Validierung dauerte zu lange. Sie werden zum Login weitergeleitet...');
            localStorage.removeItem('auth_token');
            setTimeout(() => redirectToAuth(), 2000);
          } else {
            showError('Verbindungsfehler bei der Token-Validierung: ' + error.message + '. Versuche erneut...');
            setTimeout(() => redirectToAuth(), 3000);
          }
        }
      }

      function showAdminPanel() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'block';

        // Update cache buster version to show successful login
        const cacheVersion = document.getElementById('cache-version');
        if (cacheVersion) {
          cacheVersion.textContent = `v${Date.now()}`;
        }
      }

      function showError(message) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').textContent = message;
        document.getElementById('error').style.display = 'block';
      }

      function logout() {
        localStorage.removeItem('auth_token');
        window.location.href = 'https://localhost:8443/';
      }

      // Navigation functionality
      function showSection(sectionName) {
        // Hide all sections
        document.querySelectorAll('.section').forEach(section => {
          section.classList.remove('active');
        });

        // Remove active from all nav buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('active');
        });

        // Show target section
        document.getElementById(`section-${sectionName}`).classList.add('active');
        document.getElementById(`nav-${sectionName}`).classList.add('active');

        // Load section data
        switch(sectionName) {
          case 'dashboard':
            loadDashboard();
            break;
          case 'users':
            loadUsers();
            break;
          case 'orgs':
            loadOrgs();
            break;
          case 'clients':
            loadClients();
            break;
          case 'system':
            loadSystemStatus();
            break;
          case 'audit':
            loadAuditLogs();
            break;
          case 'claims':
            loadClaims();
            break;
        }
      }

      // API helper function
      async function apiCall(endpoint, options = {}) {
        const token = localStorage.getItem('auth_token');
        const defaultOptions = {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache'
          }
        };

        const mergedOptions = {
          ...defaultOptions,
          ...options,
          headers: {
            ...defaultOptions.headers,
            ...(options.headers || {})
          }
        };

        try {
          const response = await fetch(endpoint, mergedOptions);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return await response.json();
        } catch (error) {
          console.error('API call failed:', error);
          throw error;
        }
      }

      // Dashboard functionality
      async function loadDashboard() {
        try {
          const stats = await apiCall('/api/system/stats');

          document.getElementById('stats-users').textContent = stats.users || '-';
          document.getElementById('stats-orgs').textContent = stats.organizations || '-';
          document.getElementById('stats-clients').textContent = stats.clients || '-';

          // Load claims count separately
          loadClaimsCount();
        } catch (error) {
          console.error('Failed to load dashboard stats:', error);
          document.getElementById('stats-users').textContent = 'Fehler';
          document.getElementById('stats-orgs').textContent = 'Fehler';
          document.getElementById('stats-clients').textContent = 'Fehler';
          document.getElementById('stats-claims').textContent = 'Fehler';
        }
      }

      async function loadClaimsCount() {
        try {
          const response = await apiCall('/api/claims');
          const claims = response.claims_registry?.definitions || response.claims || response.definitions || {};
          const count = Array.isArray(claims) ? claims.length : Object.keys(claims).length;
          document.getElementById('stats-claims').textContent = count;
        } catch (error) {
          console.error('Failed to load claims count:', error);
          document.getElementById('stats-claims').textContent = 'Fehler';
        }
      }

      // Users functionality
      // User management with search and pagination
      let allUsers = [];
      let filteredUsers = [];
      let currentUsersPage = 1;
      const usersPerPage = 10;

      async function loadUsers() {
        const tbody = document.getElementById('users-tbody');
        tbody.innerHTML = '<tr><td colspan="6" class="loading">Laden...</td></tr>';

        try {
          allUsers = await apiCall('/api/users');
          filteredUsers = [...allUsers];

          // Load organizations for filter dropdown
          await loadOrgFilter();

          // Reset to first page and display
          currentUsersPage = 1;
          displayUsers();
        } catch (error) {
          console.error('Failed to load users:', error);
          tbody.innerHTML = '<tr><td colspan="6" class="loading">Fehler beim Laden der Benutzer</td></tr>';
        }
      }

      async function loadOrgFilter() {
        try {
          const response = await apiCall('/api/organizations');
          const orgs = response.orgs || response || [];
          const select = document.getElementById('users-org-filter');

          select.innerHTML = '<option value="">Alle Organisationen</option>';
          orgs.forEach(org => {
            select.innerHTML += `<option value="${org.id}">${org.name || org.id}</option>`;
          });
        } catch (error) {
          console.error('Failed to load organizations for filter:', error);
        }
      }

      function searchUsers() {
        const searchTerm = document.getElementById('users-search').value.toLowerCase();
        const orgFilter = document.getElementById('users-org-filter').value;
        const statusFilter = document.getElementById('users-status-filter').value;

        filteredUsers = allUsers.filter(user => {
          const matchesSearch = !searchTerm ||
            user.email.toLowerCase().includes(searchTerm) ||
            `${user.first_name} ${user.last_name}`.toLowerCase().includes(searchTerm) ||
            (user.org && user.org.toLowerCase().includes(searchTerm));

          const matchesOrg = !orgFilter || user.org === orgFilter;
          const matchesStatus = !statusFilter || user.status === statusFilter;

          return matchesSearch && matchesOrg && matchesStatus;
        });

        currentUsersPage = 1;
        displayUsers();
      }

      function filterUsers() {
        searchUsers(); // Use the same filtering logic
      }

      function displayUsers() {
        const tbody = document.getElementById('users-tbody');

        if (filteredUsers.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="loading">Keine Benutzer gefunden</td></tr>';
          updateUsersPagination(0, 0, 0);
          return;
        }

        const startIndex = (currentUsersPage - 1) * usersPerPage;
        const endIndex = startIndex + usersPerPage;
        const pageUsers = filteredUsers.slice(startIndex, endIndex);

        tbody.innerHTML = pageUsers.map(user => `
          <tr>
            <td>${user.email}</td>
            <td>${user.first_name} ${user.last_name}</td>
            <td>${user.org || '-'}</td>
            <td>
              <button class="status-toggle status-${user.status === 'active' ? 'active' : 'inactive'}"
                      onclick="toggleUserStatus('${user.user_id || user.id}', '${user.status}', this)">
                ${user.status === 'active' ? 'Aktiv' : 'Inaktiv'}
              </button>
            </td>
            <td>${user.admin ? user.admin.join(', ') : '-'}</td>
            <td>
              <div class="actions-container">
                <button class="action-btn" onclick="editUser('${user.id}')">Bearbeiten</button>
                <button class="action-btn secondary" onclick="editUserClaims('${user.id}', '${user.email}')">Claims</button>
                <button class="action-btn danger" onclick="deleteUser('${user.id}')">Löschen</button>
              </div>
            </td>
          </tr>
        `).join('');

        updateUsersPagination(filteredUsers.length, startIndex + 1, Math.min(endIndex, filteredUsers.length));
      }

      function updateUsersPagination(total, start, end) {
        const totalPages = Math.ceil(total / usersPerPage);

        document.getElementById('users-info').textContent =
          total === 0 ? 'Keine Benutzer gefunden' : `Zeige ${start}-${end} von ${total} Benutzern`;

        document.getElementById('users-page-info').textContent =
          totalPages === 0 ? 'Seite 0 von 0' : `Seite ${currentUsersPage} von ${totalPages}`;

        document.getElementById('users-prev').disabled = currentUsersPage <= 1;
        document.getElementById('users-next').disabled = currentUsersPage >= totalPages;
      }

      function changeUsersPage(direction) {
        const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
        const newPage = currentUsersPage + direction;

        if (newPage >= 1 && newPage <= totalPages) {
          currentUsersPage = newPage;
          displayUsers();
        }
      }

      // Organizations functionality
      async function loadOrgs() {
        const tbody = document.getElementById('orgs-tbody');
        tbody.innerHTML = '<tr><td colspan="4" class="table-loading">Laden...</td></tr>';

        try {
          const response = await apiCall('/api/organizations');
          const orgs = response.orgs || response || [];

          if (orgs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="table-loading">Keine Organisationen gefunden</td></tr>';
            return;
          }

          tbody.innerHTML = orgs.map(org => `
            <tr>
              <td>${org.name || org.id}</td>
              <td>${org.description || '-'}</td>
              <td>${org.member_count || 0}</td>
              <td>
                <div class="actions-container">
                  <button class="action-btn" onclick="editOrg('${org.id}')">Bearbeiten</button>
                  <button class="action-btn danger" onclick="deleteOrg('${org.id}')">Löschen</button>
                </div>
              </td>
            </tr>
          `).join('');
        } catch (error) {
          console.error('Failed to load orgs:', error);
          tbody.innerHTML = '<tr><td colspan="4" class="table-loading">Fehler beim Laden der Organisationen</td></tr>';
        }
      }

      // Clients functionality
      async function loadClients() {
        const tbody = document.getElementById('clients-tbody');
        tbody.innerHTML = '<tr><td colspan="5" class="table-loading">Laden...</td></tr>';

        try {
          const response = await apiCall('/api/clients');
          const clients = response.clients || response || [];

          if (clients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="table-loading">Keine Clients gefunden</td></tr>';
            return;
          }

          tbody.innerHTML = clients.map(client => `
            <tr>
              <td>${client.client_id}</td>
              <td>${client.name || '-'}</td>
              <td>${client.client_type || 'confidential'}</td>
              <td>${client.redirect_uris ? client.redirect_uris.slice(0, 2).join(', ') : '-'}</td>
              <td>
                <div class="actions-container">
                  <button class="action-btn" onclick="editClient('${client.client_id}')">Bearbeiten</button>
                  <button class="action-btn danger" onclick="deleteClient('${client.client_id}')">Löschen</button>
                </div>
              </td>
            </tr>
          `).join('');
        } catch (error) {
          console.error('Failed to load clients:', error);
          tbody.innerHTML = '<tr><td colspan="5" class="table-loading">Fehler beim Laden der Clients</td></tr>';
        }
      }

      // System status functionality
      async function loadSystemStatus() {
        try {
          const status = await apiCall('/api/system/status');

          document.getElementById('auth-status').textContent =
            status.auth_service ? 'Online' : 'Offline';
          document.getElementById('admin-status').textContent = 'Online';
          document.getElementById('data-status').textContent =
            status.data_sync ? 'Synchronisiert' : 'Synchronisation erforderlich';
        } catch (error) {
          console.error('Failed to load system status:', error);
          document.getElementById('auth-status').textContent = 'Fehler';
          document.getElementById('data-status').textContent = 'Fehler';
        }
      }

      // Audit logs functionality
      async function loadAuditLogs() {
        const tbody = document.getElementById('audit-tbody');
        tbody.innerHTML = '<tr><td colspan="4" class="loading">Laden...</td></tr>';

        try {
          const logs = await apiCall('/api/audit/logs');

          if (logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="loading">Keine Audit-Logs gefunden</td></tr>';
            return;
          }

          tbody.innerHTML = logs.map(log => `
            <tr>
              <td>${new Date(log.timestamp).toLocaleString('de-DE')}</td>
              <td>${log.event_type}</td>
              <td>${log.user_id || '-'}</td>
              <td>${log.details || '-'}</td>
            </tr>
          `).join('');
        } catch (error) {
          console.error('Failed to load audit logs:', error);
          tbody.innerHTML = '<tr><td colspan="4" class="loading">Fehler beim Laden der Audit-Logs</td></tr>';
        }
      }

      // Claims functionality
      async function loadClaims() {
        const tbody = document.getElementById('claims-tbody');
        tbody.innerHTML = '<tr><td colspan="8" class="table-loading">Laden...</td></tr>';

        try {
          const response = await apiCall('/api/claims');
          const claims = response.claims_registry?.definitions || response.claims || response.definitions || {};

          if (!claims || Object.keys(claims).length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="table-loading">Keine Claims definiert</td></tr>';
            return;
          }

          tbody.innerHTML = Object.entries(claims).map(([key, definition]) => `
            <tr>
              <td><code>${key}</code></td>
              <td>${definition.type || 'string'}${definition.items ? `[${definition.items.type}]` : ''}</td>
              <td>${definition.description || '-'}</td>
              <td>${definition.required ? 'Ja' : 'Nein'}</td>
              <td>${definition.default_allowed ? 'Ja' : 'Nein'}</td>
              <td>${definition.admin_only ? 'Ja' : 'Nein'}</td>
              <td>${definition.sensitive ? 'Ja' : 'Nein'}</td>
              <td>
                <div class="actions-container">
                  <button class="action-btn" onclick="editClaim('${key}')">Bearbeiten</button>
                  <button class="action-btn danger" onclick="deleteClaim('${key}')">Löschen</button>
                </div>
              </td>
            </tr>
          `).join('');
        } catch (error) {
          console.error('Failed to load claims:', error);
          tbody.innerHTML = '<tr><td colspan="8" class="table-loading">Fehler beim Laden der Claims</td></tr>';
        }
      }

      // Claims Modal Functions
      function showCreateClaimModal() {
        document.getElementById('claim-modal-title').textContent = 'Neuen Claim erstellen';
        document.getElementById('claim-form').reset();
        document.getElementById('claim-key').disabled = false;
        openModal('claim-modal');
      }

      function editClaim(claimKey) {
        document.getElementById('claim-modal-title').textContent = 'Claim bearbeiten';
        loadClaimData(claimKey);
        document.getElementById('claim-key').disabled = true;
        openModal('claim-modal');
      }

      async function loadClaimData(claimKey) {
        try {
          const response = await apiCall('/api/claims');
          const claims = response.claims_registry?.definitions || response.claims || response.definitions || {};
          const claim = claims[claimKey];

          if (claim) {
            document.getElementById('claim-key').value = claimKey;
            document.getElementById('claim-type').value = claim.type || 'string';
            document.getElementById('claim-description').value = claim.description || '';
            document.getElementById('claim-required').checked = claim.required || false;
            document.getElementById('claim-standard-allowed').checked = claim.default_allowed || false;
            document.getElementById('claim-admin-only').checked = claim.admin_only || false;
            document.getElementById('claim-sensitive').checked = claim.sensitive || false;

            // Load default value and options
            updateClaimDefaultInput();
            const defaultValue = claim.default_value;
            if (defaultValue !== undefined && defaultValue !== null) {
              const defaultInput = document.getElementById('claim-default-value');
              if (defaultInput) {
                defaultInput.value = typeof defaultValue === 'object' ? JSON.stringify(defaultValue) : defaultValue;
              }
            }

            // Load predefined options
            const options = claim.options;
            if (options && Array.isArray(options)) {
              document.getElementById('claim-options').value = options.join('\n');
            }
          }
        } catch (error) {
          console.error('Failed to load claim data:', error);
        }
      }

      function updateClaimDefaultInput() {
        const selectedType = document.getElementById('claim-type').value;
        const container = document.getElementById('claim-default-container');

        if (!selectedType) {
          container.innerHTML = '<input type="text" id="claim-default-value" class="form-input" placeholder="Standard-Wert">';
          return;
        }

        let inputHtml = '';

        switch (selectedType) {
          case 'boolean':
            inputHtml = `
              <select id="claim-default-value" class="form-input">
                <option value="">Kein Standard</option>
                <option value="true">Ja</option>
                <option value="false">Nein</option>
              </select>
            `;
            break;
          case 'number':
            inputHtml = '<input type="number" id="claim-default-value" class="form-input" placeholder="Standard-Wert">';
            break;
          case 'array':
            inputHtml = '<textarea id="claim-default-value" class="form-input" rows="2" placeholder="Standard-Werte kommagetrennt"></textarea>';
            break;
          case 'object':
            inputHtml = '<textarea id="claim-default-value" class="form-input" rows="2" placeholder="JSON-Objekt"></textarea>';
            break;
          default:
            inputHtml = '<input type="text" id="claim-default-value" class="form-input" placeholder="Standard-Wert">';
        }

        container.innerHTML = inputHtml;
      }

      async function saveClaim() {
        const formData = {
          key: document.getElementById('claim-key').value,
          type: document.getElementById('claim-type').value,
          description: document.getElementById('claim-description').value,
          required: document.getElementById('claim-required').checked,
          default_allowed: document.getElementById('claim-standard-allowed').checked,
          admin_only: document.getElementById('claim-admin-only').checked,
          sensitive: document.getElementById('claim-sensitive').checked
        };

        // Add default value if provided
        const defaultValueInput = document.getElementById('claim-default-value');
        const defaultValue = defaultValueInput?.value?.trim();
        if (defaultValue) {
          const type = formData.type;
          try {
            switch (type) {
              case 'boolean':
                formData.default_value = defaultValue === 'true';
                break;
              case 'number':
                formData.default_value = parseFloat(defaultValue);
                if (isNaN(formData.default_value)) {
                  throw new Error('Ungültige Zahl');
                }
                break;
              case 'array':
                formData.default_value = defaultValue.split(',').map(v => v.trim()).filter(v => v);
                break;
              case 'object':
                formData.default_value = JSON.parse(defaultValue);
                break;
              default:
                formData.default_value = defaultValue;
            }
          } catch (error) {
            document.getElementById('claim-default-value-error').textContent = 'Ungültiger Default-Wert für diesen Typ';
            defaultValueInput.classList.add('error');
            return;
          }
        }

        // Add predefined options if provided
        const optionsValue = document.getElementById('claim-options').value.trim();
        if (optionsValue) {
          formData.options = optionsValue.split('\n').map(v => v.trim()).filter(v => v);
        }

        if (!validateClaimForm(formData)) {
          return;
        }

        try {
          const isEdit = document.getElementById('claim-key').disabled;
          if (isEdit) {
            await apiCall(`/api/claims/${formData.key}`, {
              method: 'PATCH',
              body: JSON.stringify(formData)
            });
          } else {
            await apiCall('/api/claims', {
              method: 'POST',
              body: JSON.stringify(formData)
            });
          }

          closeModal('claim-modal');
          loadClaims();
          loadDashboard();
        } catch (error) {
          console.error('Failed to save claim:', error);
          alert('Fehler beim Speichern des Claims');
        }
      }

      function validateClaimForm(data) {
        let isValid = true;
        clearFormErrors('claim-modal');

        if (!data.key) {
          document.getElementById('claim-key-error').textContent = 'Claim Key ist erforderlich';
          document.getElementById('claim-key').classList.add('error');
          isValid = false;
        }

        if (!data.type) {
          document.getElementById('claim-type-error').textContent = 'Typ ist erforderlich';
          document.getElementById('claim-type').classList.add('error');
          isValid = false;
        }

        return isValid;
      }

      async function deleteClaim(claimKey) {
        if (!confirm(`Möchten Sie den Claim "${claimKey}" wirklich löschen?`)) {
          return;
        }

        try {
          await apiCall(`/api/claims/${claimKey}`, { method: 'DELETE' });
          loadClaims();
          loadDashboard();
        } catch (error) {
          console.error('Failed to delete claim:', error);
          alert('Fehler beim Löschen des Claims');
        }
      }

      // User Claims Management
      let currentUserId = null;
      let currentUserEmail = null;
      let userClaims = [];
      let availableClaimTypes = {};

      async function editUserClaims(userId, userEmail) {
        currentUserId = userId;
        currentUserEmail = userEmail;

        document.getElementById('user-claims-modal-title').textContent = `Claims für ${userEmail}`;

        // Load available claim definitions and user claims
        await Promise.all([
          loadAvailableClaimTypes(),
          loadUserClaims(userId)
        ]);

        openModal('user-claims-modal');
      }

      async function loadAvailableClaimTypes() {
        try {
          const response = await apiCall('/api/claims');
          const claims = response.claims_registry?.definitions || response.claims || response.definitions || {};
          availableClaimTypes = claims;
        } catch (error) {
          console.error('Failed to load available claim types:', error);
          availableClaimTypes = {};
        }
      }

      async function loadUserClaims(userId) {
        const tbody = document.getElementById('user-claims-tbody');
        tbody.innerHTML = '<tr><td colspan="4" class="table-loading">Laden...</td></tr>';

        try {
          const users = await apiCall('/api/users');
          const user = users.find(u => (u.user_id || u.id) === userId);
          userClaims = user?.claims ? Object.entries(user.claims).map(([key, value]) => ({ key, value })) : [];

          displayUserClaims();
        } catch (error) {
          console.error('Failed to load user claims:', error);
          tbody.innerHTML = '<tr><td colspan="4" class="table-loading">Fehler beim Laden der Claims</td></tr>';
        }
      }

      function displayUserClaims() {
        const tbody = document.getElementById('user-claims-tbody');

        if (userClaims.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="table-loading">Keine Claims definiert</td></tr>';
        } else {
          tbody.innerHTML = userClaims.map((claim, index) => {
            const claimDef = availableClaimTypes[claim.key] || {};
            const claimType = claimDef.type || 'string';
            const displayValue = formatClaimValue(claim.value, claimType);

            return `
              <tr>
                <td><code>${claim.key}</code></td>
                <td>${claimType}</td>
                <td>${displayValue}</td>
                <td>
                  <div class="actions-container">
                    <button class="action-btn" onclick="editUserClaimAtIndex(${index})">Bearbeiten</button>
                    <button class="action-btn danger" onclick="deleteUserClaimAtIndex(${index})">Löschen</button>
                  </div>
                </td>
              </tr>
            `;
          }).join('');
        }

        document.getElementById('user-claims-count').textContent = `${userClaims.length} Claims`;
      }

      function formatClaimValue(value, type) {
        if (value === null || value === undefined) return '-';

        switch (type) {
          case 'boolean':
            return value ? 'Ja' : 'Nein';
          case 'array':
            return Array.isArray(value) ? value.join(', ') : JSON.stringify(value);
          case 'object':
            return typeof value === 'object' ? JSON.stringify(value) : value;
          default:
            return String(value);
        }
      }

      function addUserClaim() {
        document.getElementById('user-claim-edit-title').textContent = 'Neuer Claim';
        document.getElementById('user-claim-form').reset();

        // Populate claim key dropdown
        const select = document.getElementById('user-claim-key');
        select.innerHTML = '<option value="">Claim wählen...</option>';

        Object.entries(availableClaimTypes).forEach(([key, definition]) => {
          // Only show claims not already assigned to user
          if (!userClaims.find(c => c.key === key)) {
            select.innerHTML += `<option value="${key}">${key} (${definition.type || 'string'})</option>`;
          }
        });

        clearFormErrors('user-claim-edit-modal');
        openModal('user-claim-edit-modal');
      }

      function editUserClaimAtIndex(index) {
        const claim = userClaims[index];
        if (!claim) return;

        document.getElementById('user-claim-edit-title').textContent = 'Claim bearbeiten';

        // Populate claim key dropdown (including current selection)
        const select = document.getElementById('user-claim-key');
        select.innerHTML = '<option value="">Claim wählen...</option>';

        Object.entries(availableClaimTypes).forEach(([key, definition]) => {
          // Show all claims for editing, mark current as selected
          select.innerHTML += `<option value="${key}" ${key === claim.key ? 'selected' : ''}>${key} (${definition.type || 'string'})</option>`;
        });

        // Set current value
        updateClaimValueInput();

        // Handle different input types
        const claimDef = availableClaimTypes[claim.key];
        const type = claimDef?.type || 'string';

        if (type === 'array' && claimDef.options && Array.isArray(claimDef.options) && claimDef.options.length > 0) {
          // For checkbox arrays, check the appropriate boxes
          const currentValues = Array.isArray(claim.value) ? claim.value : [claim.value];
          setTimeout(() => {
            currentValues.forEach(value => {
              const checkbox = document.querySelector(`input[name="user-claim-array-option"][value="${value}"]`);
              if (checkbox) {
                checkbox.checked = true;
              }
            });
          }, 50); // Small delay to ensure checkboxes are rendered
        } else {
          // For other types, set the value normally
          const valueInput = document.getElementById('user-claim-value');
          if (valueInput) {
            valueInput.value = Array.isArray(claim.value) ? claim.value.join(', ') : claim.value;
          }
        }

        document.getElementById('user-claim-edit-modal').dataset.editIndex = index;

        clearFormErrors('user-claim-edit-modal');
        openModal('user-claim-edit-modal');
      }

      function updateClaimValueInput() {
        const selectedKey = document.getElementById('user-claim-key').value;
        const claimDef = availableClaimTypes[selectedKey];
        const container = document.getElementById('user-claim-value-container');

        if (!claimDef) {
          container.innerHTML = '<input type="text" id="user-claim-value" class="form-input" required>';
          return;
        }

        const type = claimDef.type || 'string';
        let inputHtml = '';

        switch (type) {
          case 'boolean':
            inputHtml = `
              <select id="user-claim-value" class="form-input" required>
                <option value="">Wählen...</option>
                <option value="true">Ja</option>
                <option value="false">Nein</option>
              </select>
            `;
            break;
          case 'number':
            inputHtml = '<input type="number" id="user-claim-value" class="form-input" required>';
            break;
          case 'array':
            // Check if there are predefined options
            if (claimDef.options && Array.isArray(claimDef.options) && claimDef.options.length > 0) {
              // Create checkbox group for predefined options
              inputHtml = `
                <div class="checkbox-options-container">
                  ${claimDef.options.map(option => `
                    <label class="checkbox-label option-checkbox">
                      <input type="checkbox" name="user-claim-array-option" value="${option}">
                      <span class="checkbox-text">${option}</span>
                    </label>
                  `).join('')}
                </div>
                <input type="hidden" id="user-claim-value" required>
              `;
            } else {
              // Fallback to textarea for free text arrays
              inputHtml = '<textarea id="user-claim-value" class="form-input" rows="3" placeholder="Werte kommagetrennt eingeben" required></textarea>';
            }
            break;
          case 'object':
            inputHtml = '<textarea id="user-claim-value" class="form-input" rows="4" placeholder="JSON-Objekt eingeben" required></textarea>';
            break;
          default:
            inputHtml = '<input type="text" id="user-claim-value" class="form-input" required>';
        }

        container.innerHTML = inputHtml;
      }

      async function saveUserClaim() {
        const key = document.getElementById('user-claim-key').value;
        const claimDef = availableClaimTypes[key];
        const type = claimDef?.type || 'string';

        let rawValue;
        let processedValue;

        // Handle array with checkbox options differently
        if (type === 'array' && claimDef.options && Array.isArray(claimDef.options) && claimDef.options.length > 0) {
          // Collect selected checkbox values
          const checkboxes = document.querySelectorAll('input[name="user-claim-array-option"]:checked');
          processedValue = Array.from(checkboxes).map(cb => cb.value);
          rawValue = processedValue.join(','); // For validation purposes
        } else {
          const valueInput = document.getElementById('user-claim-value');
          rawValue = valueInput.value;
        }

        if (!validateUserClaimForm(key, rawValue)) {
          return;
        }

        // Convert value based on type (skip array if already processed above)
        if (!(type === 'array' && claimDef.options && Array.isArray(claimDef.options) && claimDef.options.length > 0)) {
          processedValue = rawValue;
          try {
            switch (type) {
              case 'boolean':
                processedValue = rawValue === 'true';
                break;
              case 'number':
                processedValue = parseFloat(rawValue);
                if (isNaN(processedValue)) {
                  throw new Error('Ungültige Zahl');
                }
                break;
              case 'array':
                processedValue = rawValue.split(',').map(v => v.trim()).filter(v => v);
                break;
              case 'object':
                processedValue = JSON.parse(rawValue);
                break;
            }
        } catch (error) {
          document.getElementById('user-claim-value-error').textContent = 'Ungültiger Wert für diesen Typ';
          valueInput.classList.add('error');
          return;
        }

        const editIndex = document.getElementById('user-claim-edit-modal').dataset.editIndex;

        if (editIndex !== undefined && editIndex !== '') {
          // Edit existing claim
          userClaims[parseInt(editIndex)] = { key, value: processedValue };
        } else {
          // Add new claim
          userClaims.push({ key, value: processedValue });
        }

        closeModal('user-claim-edit-modal');
        displayUserClaims();
      }

      function validateUserClaimForm(key, value) {
        let isValid = true;
        clearFormErrors('user-claim-edit-modal');

        if (!key) {
          document.getElementById('user-claim-key-error').textContent = 'Claim Key ist erforderlich';
          document.getElementById('user-claim-key').classList.add('error');
          isValid = false;
        }

        if (!value.trim()) {
          document.getElementById('user-claim-value-error').textContent = 'Wert ist erforderlich';
          document.getElementById('user-claim-value').classList.add('error');
          isValid = false;
        }

        return isValid;
      }

      function deleteUserClaimAtIndex(index) {
        const claim = userClaims[index];
        if (!claim || !confirm(`Möchten Sie den Claim "${claim.key}" wirklich löschen?`)) {
          return;
        }

        userClaims.splice(index, 1);
        displayUserClaims();
      }

      async function saveUserClaims() {
        try {
          // Convert userClaims array back to object format
          const claimsObject = {};
          userClaims.forEach(claim => {
            claimsObject[claim.key] = claim.value;
          });

          await apiCall(`/api/users/${currentUserId}`, {
            method: 'PATCH',
            body: JSON.stringify({ claims: claimsObject })
          });

          closeModal('user-claims-modal');
          // Optionally refresh user list
          displayUsers();
        } catch (error) {
          console.error('Failed to save user claims:', error);
          alert('Fehler beim Speichern der Claims');
        }
      }

      // System actions
      async function reloadAuthData() {
        try {
          await apiCall('/api/system/reload', { method: 'POST' });
          alert('Auth-Daten wurden neu geladen');
          loadSystemStatus();
        } catch (error) {
          alert('Fehler beim Neuladen der Auth-Daten: ' + error.message);
        }
      }

      async function refreshSystemStatus() {
        loadSystemStatus();
      }



      // Load dashboard on startup
      document.addEventListener('DOMContentLoaded', function() {
        checkAuthentication();

        // Load dashboard data after successful auth
        setTimeout(() => {
          if (document.getElementById('admin-panel').style.display !== 'none') {
            loadDashboard();
          }
        }, 1000);
      });

      // Theme management functions
      function initializeTheme() {
        const savedTheme = localStorage.getItem('nu-theme') || 'light';
        applyTheme(savedTheme);
        console.log('Initialized theme:', savedTheme);
      }

      function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        let newTheme;

        if (currentTheme === 'dark') {
          newTheme = 'light';
        } else {
          newTheme = 'dark';
        }

        localStorage.setItem('nu-theme', newTheme);
        applyTheme(newTheme);

        console.log('Theme toggled from', currentTheme, 'to', newTheme);
      }

      function applyTheme(theme) {
        const themeToggle = document.getElementById('theme-toggle');

        if (theme === 'auto') {
          // Auto-detect based on system preference
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.setAttribute('data-theme', 'dark');
            themeToggle.textContent = 'Light';
          } else {
            document.documentElement.removeAttribute('data-theme');
            themeToggle.textContent = 'Dark';
          }
        } else if (theme === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
          themeToggle.textContent = 'Light';
        } else {
          document.documentElement.removeAttribute('data-theme');
          themeToggle.textContent = 'Dark';
        }
      }

      // Listen for system theme changes
      if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
          const savedTheme = localStorage.getItem('nu-theme');
          if (savedTheme === 'auto' || !savedTheme) {
            applyTheme('auto');
          }
        });
      }

      // Modal Functions
      function openModal(modalId) {
        document.getElementById(modalId).classList.add('show');
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
        clearFormErrors(modalId);
      }

      function clearFormErrors(modalId) {
        const modal = document.getElementById(modalId);
        const errorElements = modal.querySelectorAll('.form-error');
        errorElements.forEach(element => element.textContent = '');

        const inputElements = modal.querySelectorAll('.form-input');
        inputElements.forEach(element => element.classList.remove('error'));
      }

      // User Modal Functions
      function showCreateUserModal() {
        document.getElementById('user-modal-title').textContent = 'Neuen Benutzer erstellen';
        clearUserForm();
        document.getElementById('user-id').disabled = false;
        document.getElementById('user-id').removeAttribute('data-original-id');
        loadOrganizationOptions();
        openModal('user-modal');
      }

      function editUser(userId) {
        document.getElementById('user-modal-title').textContent = 'Benutzer bearbeiten';
        document.getElementById('user-id').disabled = true;
        loadUserData(userId);
        loadOrganizationOptions();
        openModal('user-modal');
      }

      function clearUserForm() {
        document.getElementById('user-form').reset();
        document.getElementById('user-active').checked = true;
        clearFormErrors('user-modal');
        document.getElementById('user-id').removeAttribute('data-original-id');
      }

      async function loadUserData(userId) {
        try {
          const users = await apiCall('/api/users');
          const user = users.find(u => u.user_id === userId || u.id === userId);

          if (user) {
            document.getElementById('user-id').value = user.user_id || user.id || '';
            document.getElementById('user-email').value = user.email || '';
            document.getElementById('user-first-name').value = user.first_name || '';
            document.getElementById('user-last-name').value = user.last_name || '';
            document.getElementById('user-org').value = user.org || '';
            document.getElementById('user-active').checked = user.status === 'active';
            document.getElementById('user-id').dataset.originalId = userId;
          }
        } catch (error) {
          console.error('Failed to load user data:', error);
        }
      }

      async function loadOrganizationOptions() {
        try {
          const response = await apiCall('/api/organizations');
          const orgs = response.orgs || response || [];
          const select = document.getElementById('user-org');

          select.innerHTML = '<option value="">Organisation wählen...</option>';
          orgs.forEach(org => {
            const option = document.createElement('option');
            option.value = org.id;
            option.textContent = org.name || org.id;
            select.appendChild(option);
          });
        } catch (error) {
          console.error('Failed to load organizations:', error);
        }
      }

      async function saveUser() {
        const formData = {
          user_id: document.getElementById('user-id').value,
          email: document.getElementById('user-email').value,
          first_name: document.getElementById('user-first-name').value,
          last_name: document.getElementById('user-last-name').value,
          org: document.getElementById('user-org').value,
          status: document.getElementById('user-active').checked ? 'active' : 'inactive'
        };

        const password = document.getElementById('user-password').value;
        if (password) {
          formData.password = password;
        }

        if (!(await validateUserForm(formData))) {
          return;
        }

        try {
          const isEdit = document.getElementById('user-id').dataset.originalId;
          if (isEdit) {
            await apiCall(`/api/users/${isEdit}`, {
              method: 'PATCH',
              body: JSON.stringify(formData)
            });
          } else {
            await apiCall('/api/users', {
              method: 'POST',
              body: JSON.stringify(formData)
            });
          }

          closeModal('user-modal');
          loadUsers();
          loadDashboard();
        } catch (error) {
          console.error('Failed to save user:', error);
          alert('Fehler beim Speichern des Benutzers');
        }
      }

      async function validateUserForm(data) {
        let isValid = true;
        clearFormErrors('user-modal');

        if (!data.user_id) {
          document.getElementById('user-id-error').textContent = 'Benutzer-ID ist erforderlich';
          document.getElementById('user-id').classList.add('error');
          isValid = false;
        } else {
          // Check if user ID is unique (only for new users)
          const isEdit = document.getElementById('user-id').dataset.originalId;
          if (!isEdit) {
            try {
              const existingUsers = await apiCall('/api/users');
              const userIdExists = existingUsers.some(u => (u.user_id || u.id) === data.user_id);
              if (userIdExists) {
                document.getElementById('user-id-error').textContent = 'Benutzer-ID bereits vergeben';
                document.getElementById('user-id').classList.add('error');
                isValid = false;
              }
            } catch (error) {
              console.error('Failed to validate user ID uniqueness:', error);
              document.getElementById('user-id-error').textContent = 'Fehler bei Validierung der Benutzer-ID';
              document.getElementById('user-id').classList.add('error');
              isValid = false;
            }
          }
        }

        if (!data.email) {
          document.getElementById('user-email-error').textContent = 'E-Mail ist erforderlich';
          document.getElementById('user-email').classList.add('error');
          isValid = false;
        }

        if (!data.first_name) {
          document.getElementById('user-first-name-error').textContent = 'Vorname ist erforderlich';
          document.getElementById('user-first-name').classList.add('error');
          isValid = false;
        }

        if (!data.last_name) {
          document.getElementById('user-last-name-error').textContent = 'Nachname ist erforderlich';
          document.getElementById('user-last-name').classList.add('error');
          isValid = false;
        }

        if (!data.org) {
          document.getElementById('user-org-error').textContent = 'Organisation ist erforderlich';
          document.getElementById('user-org').classList.add('error');
          isValid = false;
        }

        return isValid;
      }

      async function toggleUserStatus(userId, currentStatus, buttonElement) {
        const newStatus = currentStatus === 'active' ? 'inactive' : 'active';

        console.log(`Toggling user ${userId} status from ${currentStatus} to ${newStatus}`);

        try {
          const response = await apiCall(`/api/users/${userId}`, {
            method: 'PATCH',
            body: JSON.stringify({ status: newStatus })
          });

          console.log('Status update response:', response);

          // Update the button immediately for better UX
          if (buttonElement) {
            buttonElement.className = `status-toggle status-${newStatus}`;
            buttonElement.textContent = newStatus === 'active' ? 'Aktiv' : 'Inaktiv';
            buttonElement.setAttribute('onclick', `toggleUserStatus('${userId}', '${newStatus}', this)`);
          }

          // Reload users data from API and refresh display
          console.log('Reloading users...');
          await loadUsers();
          loadDashboard();
          console.log('Users reloaded successfully');
        } catch (error) {
          console.error('Failed to toggle user status:', error);
          alert(`Fehler beim Ändern des Benutzerstatus: ${error.message || error}`);

          // Revert button state on error if button element exists
          if (buttonElement) {
            buttonElement.className = `status-toggle status-${currentStatus}`;
            buttonElement.textContent = currentStatus === 'active' ? 'Aktiv' : 'Inaktiv';
            buttonElement.setAttribute('onclick', `toggleUserStatus('${userId}', '${currentStatus}', this)`);
          }
        }
      }

      // Organization Modal Functions
      function showCreateOrgModal() {
        document.getElementById('org-modal-title').textContent = 'Neue Organisation erstellen';
        document.getElementById('org-form').reset();
        document.getElementById('org-id').disabled = false;
        openModal('org-modal');
      }

      function editOrg(orgId) {
        document.getElementById('org-modal-title').textContent = 'Organisation bearbeiten';
        loadOrgData(orgId);
        document.getElementById('org-id').disabled = true;
        openModal('org-modal');
      }

      async function loadOrgData(orgId) {
        try {
          const response = await apiCall('/api/organizations');
          const orgs = response.orgs || response || [];
          const org = orgs.find(o => o.id === orgId);

          if (org) {
            document.getElementById('org-id').value = org.id || '';
            document.getElementById('org-name').value = org.name || '';
            document.getElementById('org-description').value = org.description || '';
          }
        } catch (error) {
          console.error('Failed to load organization data:', error);
        }
      }

      async function saveOrg() {
        const formData = {
          id: document.getElementById('org-id').value,
          name: document.getElementById('org-name').value,
          description: document.getElementById('org-description').value
        };

        if (!validateOrgForm(formData)) {
          return;
        }

        try {
          const isEdit = document.getElementById('org-id').disabled;
          if (isEdit) {
            await apiCall(`/api/organizations/${formData.id}`, {
              method: 'PATCH',
              body: JSON.stringify(formData)
            });
          } else {
            await apiCall('/api/organizations', {
              method: 'POST',
              body: JSON.stringify(formData)
            });
          }

          closeModal('org-modal');
          loadOrgs();
          loadDashboard();
        } catch (error) {
          console.error('Failed to save organization:', error);
          alert('Fehler beim Speichern der Organisation');
        }
      }

      function validateOrgForm(data) {
        let isValid = true;
        clearFormErrors('org-modal');

        if (!data.id) {
          document.getElementById('org-id-error').textContent = 'ID ist erforderlich';
          document.getElementById('org-id').classList.add('error');
          isValid = false;
        }

        if (!data.name) {
          document.getElementById('org-name-error').textContent = 'Name ist erforderlich';
          document.getElementById('org-name').classList.add('error');
          isValid = false;
        }

        return isValid;
      }

      // Client Modal Functions
      function showCreateClientModal() {
        document.getElementById('client-modal-title').textContent = 'Neuen Client erstellen';
        document.getElementById('client-form').reset();
        document.getElementById('client-id').disabled = false;
        openModal('client-modal');
      }

      function editClient(clientId) {
        document.getElementById('client-modal-title').textContent = 'Client bearbeiten';
        loadClientData(clientId);
        document.getElementById('client-id').disabled = true;
        openModal('client-modal');
      }

      async function loadClientData(clientId) {
        try {
          const response = await apiCall('/api/clients');
          const clients = response.clients || response || [];
          const client = clients.find(c => c.client_id === clientId);

          if (client) {
            document.getElementById('client-id').value = client.client_id || '';
            document.getElementById('client-name').value = client.name || '';
            document.getElementById('client-type').value = client.client_type || 'confidential';
            document.getElementById('client-redirect-uris').value = (client.redirect_uris || []).join('\n');
            document.getElementById('client-scopes').value = (client.allowed_scopes || []).join(' ');
            document.getElementById('client-require-pkce').checked = client.require_pkce || false;
          }
        } catch (error) {
          console.error('Failed to load client data:', error);
        }
      }

      async function saveClient() {
        const redirectUris = document.getElementById('client-redirect-uris').value
          .split('\n')
          .map(uri => uri.trim())
          .filter(uri => uri.length > 0);

        const scopes = document.getElementById('client-scopes').value
          .split(' ')
          .map(scope => scope.trim())
          .filter(scope => scope.length > 0);

        const formData = {
          client_id: document.getElementById('client-id').value,
          name: document.getElementById('client-name').value,
          client_type: document.getElementById('client-type').value,
          redirect_uris: redirectUris,
          allowed_scopes: scopes,
          require_pkce: document.getElementById('client-require-pkce').checked
        };

        if (!validateClientForm(formData)) {
          return;
        }

        try {
          const isEdit = document.getElementById('client-id').disabled;
          if (isEdit) {
            await apiCall(`/api/clients/${formData.client_id}`, {
              method: 'PATCH',
              body: JSON.stringify(formData)
            });
          } else {
            await apiCall('/api/clients', {
              method: 'POST',
              body: JSON.stringify(formData)
            });
          }

          closeModal('client-modal');
          loadClients();
          loadDashboard();
        } catch (error) {
          console.error('Failed to save client:', error);
          alert('Fehler beim Speichern des Clients');
        }
      }

      function validateClientForm(data) {
        let isValid = true;
        clearFormErrors('client-modal');

        if (!data.client_id) {
          document.getElementById('client-id-error').textContent = 'Client ID ist erforderlich';
          document.getElementById('client-id').classList.add('error');
          isValid = false;
        }

        if (!data.name) {
          document.getElementById('client-name-error').textContent = 'Name ist erforderlich';
          document.getElementById('client-name').classList.add('error');
          isValid = false;
        }

        return isValid;
      }

      // Delete Functions
      async function deleteUser(userId) {
        if (!confirm('Sind Sie sicher, dass Sie diesen Benutzer löschen möchten?')) {
          return;
        }

        try {
          await apiCall(`/api/users/${userId}`, { method: 'DELETE' });
          loadUsers();
          loadDashboard();
        } catch (error) {
          console.error('Failed to delete user:', error);
          alert('Fehler beim Löschen des Benutzers');
        }
      }

      async function deleteOrg(orgId) {
        if (!confirm('Sind Sie sicher, dass Sie diese Organisation löschen möchten?')) {
          return;
        }

        try {
          await apiCall(`/api/organizations/${orgId}`, { method: 'DELETE' });
          loadOrgs();
          loadDashboard();
        } catch (error) {
          console.error('Failed to delete organization:', error);
          alert('Fehler beim Löschen der Organisation');
        }
      }

      async function deleteClient(clientId) {
        if (!confirm('Sind Sie sicher, dass Sie diesen Client löschen möchten?')) {
          return;
        }

        try {
          await apiCall(`/api/clients/${clientId}`, { method: 'DELETE' });
          loadClients();
          loadDashboard();
        } catch (error) {
          console.error('Failed to delete client:', error);
          alert('Fehler beim Löschen des Clients');
        }
      }

      // Click outside modal to close
      document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
          const modalId = event.target.id;
          closeModal(modalId);
        }
      });
    </script>
  </body>
</html>